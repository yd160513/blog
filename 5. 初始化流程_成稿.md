# 前言

准备一个demo

```html
<div id="app">
    {{ a }}
</div>
...
createApp({
	setup() {
        const data = reactive({
            a: 1111
        })
        return {
            ...toRefs(data)
        }
	}
}).mount('#app')
```

这段代码中的 `createApp` 和 `mount` 两个函数就可以完成 `vue` 的初始化流程，从这里也能看到分成了两个部分: 一个是创建 `app` 实例，一个是对这个实例进行挂载。那就下来一点一点的看一下。

# createApp 创建实例

函数主要做了两件事

1. 创建 `app` 实例
2. 重写 `mount` 函数

创建 `vue` 实例仅用了一行代码

```typescript
const app = ensureRenderer().createApp(...args)
```

从字面意思可以知道在一个渲染器中有一个 `createApp` 函数。

那么 `ensureRenderer` 函数都做了什么呢？

```typescript
function ensureRenderer() {
    return renderer || (renderer = createRenderer<Node, Element>(rendererOptions))
}
```

可以看到在这里用来获取 `renderer`，如果不存在则通过 `createRenderer` 创建一个。那么 `createRenderer` 做了什么呢？

跟踪代码最终可以看到 createRenderer 最终调用的是 baseCreateRenderer 函数。这个函数是一个很庞大的函数，因为我们的主线任务是得到一个渲染器，然后从渲染其中拿到 createApp 函数。那么我们就可以先去看一下他的返回值：

```typescript
return {
    render,
    hydrate,
    createApp: createAppAPI(render, hydrate)
}
```

这里就可以清晰的看到我们调用的 createApp 函数其实调用了 createAppAPI 函数，在调用这两个函数的时候传入了 render 和 hydrate 两个函数。这两个函数都是在 baseCreateRenderer 函数中定义的，render 函数是用来卸载和做更新节点的；hydrate 函数表示注水，是在 SSR 的时候会用到，这里暂时不关心。

接下来就可以看一下 createAppAPI 函数了：

```typescript
export function createAppAPI<HostElement>(
render: RootRenderFunction,
 hydrate?: RootHydrateFunction
): CreateAppFunction<HostElement> {
    return function createApp(rootComponent, rootProps = null) {
        const context = createAppContext()
        const installedPlugins = new Set()
        let isMounted = false
        // vue 实例
        const app: App = (context.app = {
            //...
        })
        // 将 app 实例 return
        return app
    }
}
```

createAppAPI 函数接收两个参数，但是函数内部直接 return 了 createApp 函数。在 createApp 函数中定义了上下文也创建了 app 实例并 return。在 app 中定义了一些我们常见的函数其中就有 mount 函数。

至此，创建 app 实例这一步我们就搞清楚了：

> 1. 得到一个 renderer 
> 2. 从 renderer 中拿到 createApp 并调用得到 app 实例

# mount 

重写 `mount` 函数主要是将选择器转为 `DOM` 节点作为容器然后再去调用原来的都 `mount` 函数。









# 问题

- 创建 `app` 实例的两个函数都做了什么



























































































































